<UserControl x:Class="KLPlugins.Leaderboard.SettingsControlDemo"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:KLPlugins.Leaderboard"
             xmlns:styles="clr-namespace:SimHub.Plugins.Styles;assembly=SimHub.Plugins" 
             mc:Ignorable="d" 
             xmlns:Mah="http://metro.mahapps.com/winfx/xaml/controls"
             xmlns:ui="clr-namespace:SimHub.Plugins.UI;assembly=SimHub.Plugins" 
             xmlns:mdxam="clr-namespace:MdXaml;assembly=MdXaml"
             xmlns:mde="clr-namespace:MdXaml.Ext"
             d:DesignHeight="300" d:DesignWidth="600" 
             Loaded="UserControl_Loaded">

    <UserControl.Resources>
        <!-- Limit tooltip width. -->
        <Style TargetType="ToolTip">
            <Style.Resources>
                <Style TargetType="ContentPresenter">
                    <Style.Resources>
                        <Style TargetType="TextBlock">
                            <Setter Property="TextWrapping" Value="Wrap" />
                        </Style>
                    </Style.Resources>
                </Style>
            </Style.Resources>
            <Setter Property="MaxWidth" Value="300" />
        </Style>

        <!-- Default toggle button style -->
        <Style TargetType="styles:SHToggleButton">
            <Setter Property="Width" Value="75" />
            <Setter Property="Height" Value="20" />
        </Style>

        <!-- Default text block style -->
        <Style TargetType="TextBlock">
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Margin" Value="5,5,0,5" />
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>

        <!-- Default section style -->
        <Style TargetType="styles:SHSectionTitle">
            <Setter Property="FontSize" Value="20"/>
        </Style>

        <!-- Markdown style based on https://github.com/whistyun/MdXaml/blob/master/MdXaml/MarkdownMigFree.Style.xaml -->
        <Style TargetType="FlowDocument" x:Key="DocumentStyle">
            <Setter Property="FontFamily"    Value="Helvetica" />
            <Setter Property="TextAlignment" Value="Left" />
            <Setter Property="PagePadding"   Value="0"/>
            <Setter Property="FontSize"      Value="14"/>

            <Style.Resources>
                <Style TargetType="Section">
                    <Setter Property="Padding"         Value="10, 5"/>
                    <Setter Property="BorderBrush"     Value="#DEDEDE"/>
                    <Setter Property="BorderThickness" Value="5,0,0,0"/>
                </Style>

                <Style TargetType="avalonEdit:TextEditor" xmlns:avalonEdit="http://icsharpcode.net/sharpdevelop/avalonedit">
                    <Setter Property="Background"                    Value="#EEEEEE"/>
                    <Setter Property="HorizontalScrollBarVisibility" Value="Auto"/>
                    <Setter Property="VerticalScrollBarVisibility"   Value="Auto"/>
                    <Setter Property="Margin"                        Value="2,0,2,0"/>
                    <Setter Property="Padding"                       Value="3"/>
                </Style>

                <Style TargetType="Paragraph">
                    <Setter Property="Margin" Value="0, 7, 0, 0"/>

                    <Style.Triggers>
                        <Trigger Property="Tag" Value="Heading1">
                            <Setter Property="Margin" Value="0, 0, 15, 0"/>

                            <Setter Property="Foreground"  Value="#ff000000" />
                            <Setter Property="FontSize"    Value="28"/>
                            <Setter Property="FontWeight"  Value="Bold" />
                        </Trigger>

                        <Trigger Property="Tag" Value="Heading2">
                            <Setter Property="Margin" Value="0, 0, 15, 0"/>

                            <Setter Property="Foreground"  Value="#ff000000" />
                            <Setter Property="FontSize"    Value="21"/>
                            <Setter Property="FontWeight"  Value="Bold" />
                        </Trigger>

                        <Trigger Property="Tag" Value="Heading3">
                            <Setter Property="Margin" Value="0, 0, 10, 0"/>

                            <Setter Property="Foreground"  Value="#ff000000" />
                            <Setter Property="FontSize"    Value="17" />
                            <Setter Property="FontWeight"  Value="Bold" />
                        </Trigger>

                        <Trigger Property="Tag" Value="Heading4">
                            <Setter Property="Margin" Value="0, 0, 5, 0"/>

                            <Setter Property="Foreground"  Value="#ff000000" />
                            <Setter Property="FontSize"    Value="14"/>
                            <Setter Property="FontWeight"  Value="Bold" />
                        </Trigger>

                        <Trigger Property="Tag" Value="CodeBlock">
                            <Setter Property="FontFamily" Value="Helvetica"/>
                            <Setter Property="FontSize"   Value="12"/>
                            <Setter Property="Background" Value="#12181F25"/>
                            <Setter Property="Padding"     Value="20, 10"/>
                        </Trigger>

                        <Trigger Property="Tag" Value="Note">
                            <Setter Property="Margin"      Value="5,0,5,0"/>
                            <Setter Property="Padding"     Value="10, 5"/>
                            <Setter Property="BorderBrush" Value="#DEDEDE"/>
                            <Setter Property="BorderThickness" Value="3,3,3,3"/>
                            <Setter Property="Background"  Value="#FAFAFA"/>
                        </Trigger>

                    </Style.Triggers>
                </Style>

                <Style TargetType="Run">
                    <Style.Triggers>
                        <Trigger Property="Tag" Value="CodeSpan">
                            <Setter Property="FontFamily" Value="Helvetica"/>
                            <Setter Property="FontSize"   Value="14"/>
                            <Setter Property="Background" Value="#12181F25"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>

                <Style TargetType="Hyperlink">
                    <Setter Property="TextDecorations"    Value="None" />
                </Style>

            </Style.Resources>
        </Style>

    </UserControl.Resources>

    <styles:SHTabControl>
        <styles:SHTabItem  Header="Plugin info">
            <mdxam:MarkdownScrollViewer MarkdownStyle="{StaticResource DocumentStyle}" xml:space="preserve">
# ACC Leaderboard Plugin

This is an ACC specific (at least at the moment) leaderboard plugin. 
I know that there are other leaderboard plugins around but I wanted to try my own, maybe someone else finds it useful.

The thing to know about it is that we expose car properties only once in overall order through `Overall.xx.&lt;property name` properties. This means that we don't need to expose same property in multiple leaderboards like overall, class or relative. This also means that number of overall positions exported should be larger or equal to the number of total cars. 
Otherwise class or relative leaderboards may not have access to all the cars they need. The number of shown overall positions can be changed in settings.


## Constructing leaderboards in different order

Class or relative leaderboards can be constructed through `InClass.xx.OverallPosition` which returns the overall position of xx-th car in class.
Then we can access all of the properties of that car from overall order.
This means doing following
```javascript
var overallPos = $prop('LeaderboardPlugin.InClass.' + format(classPos, '00') + '.OverallPosition')
if (overallPos == null) return null;
return $prop('LeaderboardPlugin.Overall.' + format(overallPos, '00') + '.' + 'CarNumber')
```

Granted this complicates accessing car properties a little but with the plugin is provided a JavaScript extension file 
which provies functions to do above and simplify accessing car properties. For example the car number of 5th car in class can be accessed by 

```javascript
return InClass(5, 'CarNumber')
```
and similarly for other orderings.

Currently we provide:
 - `Overall(pos, propname)`: Get property `propname` for `pos`-th car overall.
 - `InClass(pos, propname)`: Get property `propname` for `pos`-th car in class.
 - `OverallRelativeToFocused(pos, propname, numRelPos)`: Get property `propname` for `pos`-th car relative to currently focused car in overall order. Note that `pos` starts from 1 and that would be the car that is `numRelPos` positions ahead of the focused car. `pos == numRelPos + 1` is the focused car and `pos == 2numRelPos + 1` is the last car shown and `numRelPos` behind the focused car. The reason for this is that in SimHub you probably use repeated group to build the leaderboard and it's indexer `repeatindex()` starts at 1. So we also start counting at 1.
 - `OverallRelativeToFocusedPartial(pos, propname, numRelPos, numOverallPos)`: Get property `propname` for `pos`-th car relative to currently focused car in overall order or `pos`-th car overall if `pos &lt; numOverallPos`. That is we show `numOverallPos` positions from the top of overall standings and then `numRelPos` realative positions around each side of focused car. See "Relative overall" screen on example dash.
 - `RelativeOnTrack(pos, propname)`: Get property `propname` for `pos`-th car relative to currently focused car. Note that `pos` starts from 1. That is if `n` is the number of relative position specified in settings then `pos=1` is the car that is `n` positions ahead of focused car. `pos == n+1` is the focused car and `pos == 2n+1` is the last car, `n` positions behind focused car.
 - `Focused(propname)`: Get property `propname` for currently focused car.
 - `OverallBestLap(propname)`: Get property `propname` for the car that has best lap overall.
 - `InClassBestLap(propname)`: Get property `propname` for the car that has best lap in class.

For more examples you can see example dashboard provided with the plugin.



## Settings

Plugin comes with bunch of options. You can change number of positions shown. You can also disable any of the properties that you don't care about. Note however that for the functions from above to work you need to have corresponding orderings enabled.

## SH version

Last SimHub version this plugin was tested is 7.4.23.
	            </mdxam:MarkdownScrollViewer>

        </styles:SHTabItem>


        <styles:SHTabItem Header="General settings">
            <StackPanel x:Name="GenSettings_StackPanel" Margin="20" CanVerticallyScroll="True">

                <!-- ACC Config location -->
                
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="ACC configuration location: " Width="200"/>
                    <TextBox x:Name="AccDataLocation_TextBox" Width="500" 
                                 HorizontalAlignment="Left" 
                                 TextChanged="AccDataLocation_TextChanged" 
                                 ToolTip="Location of ACC configuration folder. That is where for example ..\Config\broadcasting.json is located."/>
                </StackPanel>

                <!-- Num overall pos -->

                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Number of overall positions: " Width="200"/>
                    <Mah:NumericUpDown x:Name="NumOverallPos_NumericUpDown" 
                                           HasDecimals="False" 
                                           Width="100" 
                                           Minimum="0" Maximum="100" Interval="1" 
                                           ValueChanged="NumOverallPos_NumericUpDown_ValueChanged"
                                           ToolTip="Set number of overall positions exposed as properties. Note that this must be larger than all the cars as otherwise in class and relative positions may be missing some cars."/>
                </StackPanel>

                <!-- Num relative pos -->
                
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Number of relative positions: " Width="200"/>
                    <Mah:NumericUpDown x:Name="NumRelativePos_NumericUpDown" 
                                           HasDecimals="False" 
                                           Width="100" 
                                           Minimum="0" Maximum="100" Interval="1" 
                                           ValueChanged="NumRelativePos_NumericUpDown_ValueChanged"
                                           ToolTip="Set number of relative positions exposed from the focused car in one direction. That is if it's set to 5, we show 5 cars ahead and 5 behind."
                                           />
                </StackPanel>

                <!-- Num drivers -->
                
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Number of drivers: " Width="200"/>
                    <Mah:NumericUpDown x:Name="NumDrivers_NumericUpDown" 
                                           HasDecimals="False" 
                                           Width="100" 
                                           Minimum="0" Maximum="10" Interval="1" 
                                           ValueChanged="NumDrivers_NumericUpDown_ValueChanged"
                                           ToolTip="Set number of drivers shown per car. Should be higher or equal to the number of maximum drivers possible for you."/>
                </StackPanel>

                <!-- Update interval -->

                <StackPanel Orientation="Horizontal">
                <TextBlock Text="Data update interval: " Width="200"/>
                <Mah:NumericUpDown x:Name="UpdateInterval_NumericUpDown" 
                                        HasDecimals="False" 
                                        Width="100" 
                                        Minimum="10" Maximum="5000" Interval="10" 
                                        ValueChanged="UpdateRate_NumericUpDown_ValueChanged"
                                        ToolTip="Sets the update interval of data from ACC. As leaderboard data doesn't change that fast something around 1000ms should work very well. But you can go lower to provide smoother visuals."/>
                </StackPanel>

                <!-- Enable logging -->
                
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Log info: " Width="200"/>
                    <styles:SHToggleButton x:Name="Logging_ToggleButton" 
                                               Click="Logging_ToggleButton_Click"
                                               ToolTip="Enable or disable information logging. Errors will still be logged."/>
                </StackPanel>
            </StackPanel>
        </styles:SHTabItem>

        <styles:SHTabItem Header="Exposed properties">

            <ScrollViewer>
                <StackPanel>

                    <TextBlock x:Name="ExposedPropertiesInfo_TextBlock" 
                               Text="Here you can select all the properties you wish to use."
                               TextWrapping="Wrap" HorizontalAlignment="Left"/>

                    <!-- Properties for each car -->
                    
                    <Separator Margin="0,15,0,1"/>
                    <Separator Margin="0,1,0,10"/>
                    <styles:SHSectionTitle Text="PROPERTIES FOR EACH CAR"/>
                    <StackPanel x:Name="ExposedCarProperties_StackPanel"/>

                    <!-- Exposed drivers -->

                    <Separator Margin="0,15,0,1"/>
                    <Separator Margin="0,1,0,10"/>
                    <styles:SHSectionTitle Text="EXPOSED DRIVERS"/>
                    <StackPanel x:Name="ExposedDrivers_StackPanel">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Current driver: " Width="100"/>
                            <styles:SHToggleButton x:Name="CurrentDriverInfo_ToggleButton" 
                                               ToolTip="Expose properties of current driver."/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="All drivers: " Width="100"/>
                            <styles:SHToggleButton x:Name="AllDriversInfo_ToggleButton" 
                                               ToolTip="Expose properties of all drivers."/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Properties for each car -->
                    
                    <Separator Margin="0,15,0,1"/>
                    <Separator Margin="0,1,0,10"/>
                    <styles:SHSectionTitle Text="PROPERTIES FOR EACH DRIVER"/>
                    <StackPanel x:Name="ExposedDriverProperties_StackPanel"/>

                    <!-- Other properties -->

                    <Separator Margin="0,15,0,1"/>
                    <Separator Margin="0,1,0,10"/>
                    <styles:SHSectionTitle Text="OTHER PROPERTIES"/>
                    <StackPanel x:Name="OtherProperties_StackPanel"/>

                    <!-- -->

                </StackPanel>
            </ScrollViewer>


        </styles:SHTabItem>

        <styles:SHTabItem Header="Exposed orderings">
            <ScrollViewer>
                <StackPanel>
                    <TextBlock x:Name="ExposedOrderingsInfo_TextBlock" TextWrapping="Wrap" HorizontalAlignment="Left"/>

                    <Separator Margin="0,15,0,1"/>
                    <Separator Margin="0,1,0,10"/>
                    <StackPanel x:Name="ExposedOrderings_StackPanel"/>

                </StackPanel>
            </ScrollViewer>
        </styles:SHTabItem>

    </styles:SHTabControl>

</UserControl>
